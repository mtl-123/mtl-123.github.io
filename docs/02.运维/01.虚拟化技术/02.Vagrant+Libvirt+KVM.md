---
title: Vagrant+Libvirt+KVM
date: 2025-06-11 22:38:23
permalink: /pages/f075bc/
categories:
  - è¿ç»´
  - è™šæ‹ŸåŒ–æŠ€æœ¯
tags:
  - Vagrant+Libvirt+KVM
author: 
  name: MeiChen
  link: https://github.com/mtl-123
---



è¯¦ç»†è®²è§£äº†å¦‚ä½•åœ¨ **Ubuntu 25.04 (Noble Numbat)** ä¸Šä½¿ç”¨ Vagrant + Libvirt/KVM æ„å»º Redis é›†ç¾¤ç¯å¢ƒï¼Œå¹¶åŒ…æ‹¬ä»å®‰è£… KVMã€é…ç½®æ¡¥æ¥ç½‘ç»œ `br0` åˆ°éƒ¨ç½²å®Œæ•´é›†ç¾¤çš„å…¨è¿‡ç¨‹ã€‚

---

# ğŸš€ ä½¿ç”¨ Vagrant + KVM æ­å»º Redis é›†ç¾¤ï¼ˆ3ä¸»3ä»ï¼‰ç¯å¢ƒå…¨æ”»ç•¥  
> åŸºäº Ubuntu 25.04 | æ”¯æŒæ¡¥æ¥ç½‘ç»œã€èµ„æºéš”ç¦»ã€SSH ä¼˜åŒ–

## ğŸ“Œ èƒŒæ™¯ä¸ç›®æ ‡

åœ¨å­¦ä¹ å’Œæµ‹è¯•åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆå¦‚ Redis Clusterï¼‰æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦ä¸€ä¸ªç¨³å®šçš„å¤šèŠ‚ç‚¹è™šæ‹ŸåŒ–ç¯å¢ƒã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ **Ubuntu 25.04** ç³»ç»Ÿä¸Šï¼š

- å®‰è£…å¹¶é…ç½® KVM/QEMU Libvirt
- åˆ›å»ºæ¡¥æ¥ç½‘ç»œ `br0`
- ä½¿ç”¨ Vagrant è‡ªåŠ¨åŒ–éƒ¨ç½² 6 å° Redis èŠ‚ç‚¹ï¼ˆ3 ä¸» 3 ä»ï¼‰
- å¯ç”¨ root ç™»å½•ã€ä¼˜åŒ– SSH è¿æ¥ä½“éªŒ
- æä¾›å¯æ‰©å±•æ€§æ–¹æ¡ˆï¼ˆAnsibleã€è‡ªå®šä¹‰é•œåƒç­‰ï¼‰

---

## ğŸ§° å‡†å¤‡å·¥ä½œ

### âœ… ç¡¬ä»¶è¦æ±‚

- æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–çš„ CPUï¼ˆIntel VT-x / AMD-Vï¼‰
- è‡³å°‘ 16GB å†…å­˜ï¼ˆç”¨äºè¿è¡Œå¤šä¸ª VMï¼‰
- è‡³å°‘ 50GB ç£ç›˜ç©ºé—´

### âœ… è½¯ä»¶ç¯å¢ƒ

- Ubuntu 25.04 Server æˆ– Desktop
- å·²è¿æ¥äº’è”ç½‘ä»¥ä¸‹è½½ä¾èµ–åŒ…

---

## ğŸ”§ ç¬¬ä¸€æ­¥ï¼šå®‰è£… KVM å’Œç›¸å…³å·¥å…·

```bash
sudo apt update && sudo apt upgrade -y

# å®‰è£…æ ¸å¿ƒç»„ä»¶
sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager ovmf

# æ·»åŠ å½“å‰ç”¨æˆ·åˆ° libvirt ç»„
sudo usermod -aG libvirt $USER
sudo usermod -aG kvm $USER

# é‡å¯ç”Ÿæ•ˆç»„æƒé™
newgrp libvirt
```

> âš ï¸ æ³¨æ„ï¼šæ‰§è¡Œå®Œ `newgrp libvirt` åå»ºè®®é‡æ–°ç™»å½•ç»ˆç«¯æˆ–æ–°å¼€ shell çª—å£

---

## ğŸŒ ç¬¬äºŒæ­¥ï¼šé…ç½®æ¡¥æ¥ç½‘ç»œ br0

Vagrant é»˜è®¤ä½¿ç”¨ NAT æ¨¡å¼ï¼Œä½†åœ¨ç”Ÿäº§æ¨¡æ‹Ÿä¸­æˆ‘ä»¬æ›´å¸Œæœ›ä½¿ç”¨æ¡¥æ¥æ¨¡å¼è®©è™šæ‹Ÿæœºè·å¾—çœŸå® IPã€‚

### ğŸ“ ç¼–è¾‘ Netplan é…ç½®æ–‡ä»¶ï¼ˆè·¯å¾„å¯èƒ½ä¸åŒï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰

```bash
sudo vim /etc/netplan/*.yaml
```

æ›¿æ¢ä¸ºå¦‚ä¸‹å†…å®¹ï¼ˆè¯·æ ¹æ®ä½ çš„ç‰©ç†ç½‘å¡åç§°è°ƒæ•´ `enpXsY`ï¼‰ï¼š

```yaml
network:
  version: 2
  ethernets:
    enp1s0:
      dhcp4: no
  bridges:
    br0:
      interfaces: [enp1s0]
      dhcp4: yes
      parameters:
        stp: true
        forward-delay: 4
```

### ğŸ”„ åº”ç”¨é…ç½®

```bash
sudo netplan apply
```

### ğŸ“Œ æŸ¥çœ‹æ¡¥æ¥æ¥å£çŠ¶æ€

```bash
ip a show br0
```

---

## ğŸ“¦ ç¬¬ä¸‰æ­¥ï¼šå®‰è£… Vagrant å¹¶æ·»åŠ  Libvirt æ’ä»¶

### ğŸ“¥ å®‰è£… Vagrant

```bash
wget https://releases.hashicorp.com/vagrant/2.4.2/vagrant_2.4.2_linux_amd64.zip
unzip vagrant_2.4.2_linux_amd64.zip
sudo mv vagrant /usr/local/bin/
```

éªŒè¯æ˜¯å¦æˆåŠŸï¼š

```bash
vagrant --version
```

### ğŸ§© å®‰è£… Libvirt æ’ä»¶

```bash
vagrant plugin install vagrant-libvirt
```

---

## ğŸ“„ ç¬¬å››æ­¥ï¼šç¼–å†™ Vagrantfile éƒ¨ç½² Redis é›†ç¾¤èŠ‚ç‚¹

åˆ›å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•ï¼š

```bash
mkdir redis-cluster && cd redis-cluster
vim Vagrantfile
```

ç²˜è´´å¦‚ä¸‹å®Œæ•´ Vagrantfileï¼š

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  config.vm.box = "bento/ubuntu-24.04"
  config.vm.box_version = "202502.21.0"
  config.vm.synced_folder ".", "/vagrant", disabled: true

  config.vm.provider :libvirt do |libvirt|
    libvirt.driver = "kvm"
    libvirt.connect_via_ssh = false
    libvirt.storage_pool_name = "default"
  end

  nodes = [
    { name: :redis_master1, ip: "192.168.100.10", hostname: "redis-master1", memory: 4096, cpus: 2 },
    { name: :redis_master2, ip: "192.168.100.11", hostname: "redis-master2", memory: 8192, cpus: 4 },
    { name: :redis_master3, ip: "192.168.100.12", hostname: "redis-master3", memory: 4096, cpus: 2 },
    { name: :redis_slave1,  ip: "192.168.100.13", hostname: "redis-slave1",  memory: 4096, cpus: 2 },
    { name: :redis_slave2,  ip: "192.168.100.14", hostname: "redis-slave2",  memory: 4096, cpus: 1 },
    { name: :redis_slave3,  ip: "192.168.100.15", hostname: "redis-slave3",  memory: 2048, cpus: 1 }
  ]

  nodes.each do |node|
    config.vm.define node[:name] do |machine|
      machine.vm.hostname = node[:hostname]

      machine.vm.network :public_network,
        dev: "br0",
        mode: "bridge",
        type: "bridge"

      machine.vm.provider :libvirt do |domain|
        domain.memory = node.fetch(:memory, 2048)
        domain.cpus = node.fetch(:cpus, 1)
        domain.disk_bus = "virtio"
        domain.disk_driver cache: 'none', io: 'native'
      end

      machine.vm.provision "install-common-tools", type: "shell", inline: <<-SHELL
        echo "ğŸ”„ æ­£åœ¨æ›´æ–° apt ç¼“å­˜..."
        apt update -y

        echo "ğŸ“¦ å®‰è£…å¸¸ç”¨å·¥å…·ï¼šgit lrzsz wget curl vim net-tools..."
        apt install -y git lrzsz wget curl vim net-tools software-properties-common

        echo "âœ… å¸¸ç”¨å·¥å…·å®‰è£…å®Œæˆ"
      SHELL

      machine.vm.provision "enable-root-ssh", type: "shell", inline: <<-SHELL
        echo "ğŸ” è®¾ç½® root å¯†ç å¹¶å¯ç”¨ SSH ç™»å½•..."

        echo "root:vagrant" | chpasswd

        if ! grep -q "PermitRootLogin yes" /etc/ssh/sshd_config; then
          sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        fi

        if ! grep -q "PasswordAuthentication yes" /etc/ssh/sshd_config; then
          sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        fi

        mkdir -p /root/.ssh
        cp /home/vagrant/.ssh/authorized_keys /root/.ssh/
        chown -R root:root /root/.ssh
        chmod 700 /root/.ssh
        chmod 600 /root/.ssh/authorized_keys

        systemctl restart ssh

        echo "âœ… root ç™»å½•å·²å¯ç”¨"
      SHELL

      machine.vm.provision "optimize-ssh", type: "shell", inline: <<-SHELL
        echo "ğŸ”§ ä¼˜åŒ– SSH é…ç½®..."

        if ! grep -q "UseDNS no" /etc/ssh/sshd_config; then
          echo "UseDNS no" >> /etc/ssh/sshd_config
        fi

        if ! grep -q "GSSAPIAuthentication no" /etc/ssh/sshd_config; then
          echo "GSSAPIAuthentication no" >> /etc/ssh/sshd_config
        fi

        if ! grep -q "ClientAliveInterval 300" /etc/ssh/sshd_config; then
          echo "ClientAliveInterval 300" >> /etc/ssh/sshd_config
        fi

        if ! grep -q "ClientAliveCountMax 3" /etc/ssh/sshd_config; then
          echo "ClientAliveCountMax 3" >> /etc/ssh/sshd_config
        fi

        systemctl restart ssh

        echo "âœ… SSH å·²ä¼˜åŒ–ï¼šç¦ç”¨ DNS + å¯ç”¨ä¿æ´»"
      SHELL

    end
  end

end
```

---

## â–¶ï¸ ç¬¬äº”æ­¥ï¼šå¯åŠ¨é›†ç¾¤ç¯å¢ƒ

```bash
vagrant up --provider=libvirt
```

> â±ï¸ ç¬¬ä¸€æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ box é•œåƒï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚

---

## ğŸ“‹ ç¬¬å…­æ­¥ï¼šè®¿é—®å’Œç®¡ç†è™šæ‹Ÿæœº

### ğŸ” æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€

```bash
vagrant status
```

### ğŸ’» SSH ç™»å½•æŸå°æœºå™¨

```bash
vagrant ssh redis_master1
```

### ğŸ§‘â€ğŸ’» ä½¿ç”¨ root ç™»å½•

```bash
ssh root@192.168.100.10
# å¯†ç ï¼švagrant
```

---

## ğŸ“ˆ å¯é€‰å¢å¼ºåŠŸèƒ½ï¼ˆè¿›é˜¶ï¼‰

| åŠŸèƒ½ | å®ç°æ–¹å¼ |
|------|----------|
| è‡ªåŠ¨ç”Ÿæˆ Ansible Playbook | è‡ªåŠ¨åŒ–éƒ¨ç½² Redis é›†ç¾¤ |
| æ„å»ºè‡ªå®šä¹‰ box é•œåƒï¼ˆé¢„è£…å·¥å…·+SSHä¼˜åŒ–ï¼‰ | ä½¿ç”¨ Packer |
| å°è£…ä¸€é”®å¯åŠ¨è„šæœ¬ | å†™ä¸€ä¸ª `start.sh` å¯åŠ¨è„šæœ¬ |
| æ·»åŠ  Redis ä¸€é”®éƒ¨ç½²è„šæœ¬ | åŒ…æ‹¬ä¸»ä»ã€é›†ç¾¤æ¨¡å¼åˆå§‹åŒ– |
| æ”¯æŒ Kubernetes éƒ¨ç½² | åŠ å…¥ kubeadm åˆå§‹åŒ–è„šæœ¬ |

---

## âœ… æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å·²ç»æŒæ¡äº†ï¼š

- å¦‚ä½•åœ¨ Ubuntu 25.04 ä¸Šæ­å»ºåŸºäº KVM çš„è™šæ‹ŸåŒ–å¹³å°
- å¦‚ä½•é…ç½®æ¡¥æ¥ç½‘ç»œ `br0`
- å¦‚ä½•ä½¿ç”¨ Vagrant è‡ªåŠ¨åŒ–éƒ¨ç½² Redis é›†ç¾¤èŠ‚ç‚¹
- å¦‚ä½•ä¼˜åŒ– SSH ç™»å½•ä½“éªŒå’Œå®‰å…¨æ€§

è¿™å¥—ç¯å¢ƒéå¸¸é€‚åˆç”¨äº Redis Cluster å­¦ä¹ ã€æµ‹è¯•ä»¥åŠ CI/CD åœºæ™¯ä¸­çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

---

## ğŸ“¬ å¦‚æœä½ éœ€è¦æˆ‘ä¸ºä½ å®šåˆ¶ï¼š

- æ•´å¥— Ansible è‡ªåŠ¨éƒ¨ç½² Redis é›†ç¾¤è„šæœ¬
- ä½¿ç”¨ Packer æ„å»ºé¢„è£…ç¯å¢ƒçš„ Vagrant Box
- å›¾å½¢ç•Œé¢ç‰ˆæœ¬ï¼ˆå¸¦ Virt-Manager æ”¯æŒï¼‰
- é›†æˆ Prometheus/Grafana ç›‘æ§
- æ”¯æŒ Kubernetes ç¯å¢ƒé›†æˆ



---




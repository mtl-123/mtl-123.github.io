---
title: auditd
date: 2025-05-30 15:53:39
permalink: /pages/909467/
categories:
  - 系统
  - 系统
  - Linux
  - 日志管理
tags:
  - auditd
author:
  name: MeiChen
  link: https://github.com/mtl-123
---


# Linux Auditd 配置手册：监控用户登录时间与统计未登录用户

---

## **一、安装 Auditd 服务**

```bash
sudo apt-get update
sudo apt-get install auditd audispd-plugins -y
```

---

## **二、配置 Auditd 主文件**

编辑 `/etc/audit/auditd.conf`，调整以下核心参数：

```bash
# 日志文件路径（默认已存在）
log_file = /var/log/audit/audit.log

# 日志格式（推荐 ENRICHED 以包含更多上下文）
log_format = ENRICHED

# 日志轮转策略
max_log_file = 8         # 单个日志文件最大大小（MB）
max_log_file_action = ROTATE  # 超出大小后轮转
num_logs = 5             # 保留历史日志文件数量

# 磁盘空间告警（触发时暂停写入）
admin_space_left_action = SUSPEND
disk_full_action = SUSPEND

# 日志队列深度（防止日志丢失）
q_depth = 2000
overflow_action = SYSLOG
```

> **生效配置**：修改后重启服务 `sudo systemctl restart auditd`

---

## **三、添加审计规则（监控登录事件）**

### **1. 监控用户登录/登出事件**

无需额外规则，Auditd 默认已记录以下事件：

- **登录成功**：`USER_LOGIN` 类型
- **登出**：`USER_LOGOUT` 类型
- **SSH 登录尝试**：`sshd` 相关事件

### **2. 自定义规则（可选）**

若需更精细控制，添加规则到 `/etc/audit/rules.d/audit.rules`：

```bash
# 监控 PAM 模块认证事件（涵盖登录）
-w /var/log/auth.log -p wa -k auth_events

# 监控 SSH 登录会话（记录 session opened/closed）
-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k ssh_login
```

> **生效规则**：

```bash
sudo augenrules --load   # 加载新规则
sudo auditctl -l         # 验证规则列表
```

---

## **四、查询用户登录记录**

### **1. 使用 `ausearch` 查询指定时间范围**

```bash
# 查询今日所有登录事件
sudo ausearch --start today -k login

# 查询特定用户（如 user1）的登录记录
sudo ausearch -ua user1

# 查询 SSH 登录事件
sudo ausearch -k ssh_login
```

### **2. 使用 `aureport` 生成摘要报告**

```bash
# 生成登录事件日报
sudo aureport --login --summary

# 生成指定日期的登录报告（如 2025-05-01）
sudo aureport --start 05/01/2025 --end 05/02/2025 --login
```

---

## **五、统计长期未登录用户**

Auditd 本身不直接提供“未登录用户”统计，需结合系统命令实现：

### **1. 使用 `lastlog` 命令（推荐）**

```bash
# 列出所有用户最近登录时间
sudo lastlog

# 过滤超过 90 天未登录的用户（示例）
sudo lastlog | awk '$5 == "**Never logged in**" || $NF+0 < $(date +%s -d "90 days ago") {print $1}'
```

### **2. 结合 Audit 日志分析**

```bash
# 提取所有用户的最新登录时间戳
sudo ausearch --raw --login | grep 'auid=' | awk '{print $3}' | sort -u > /tmp/active_users.txt

# 对比系统用户列表
comm -23 <(cut -d: -f1 /etc/passwd | sort) <(sort /tmp/active_users.txt)
```

---

## **六、日志轮转与清理**

配置 `/etc/logrotate.d/auditd` 优化日志管理：

```bash
/var/log/audit/audit.log {
    weekly
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 0640 root adm
}
```

---

## **七、验证配置**

1. **模拟登录事件**：

   ```bash
   ssh testuser@localhost  # 产生登录日志
   ```

2. **检查日志输出**：

   ```bash
   sudo ausearch -k login | grep 'user='
   ```

---

## **八、常见问题排查**

1. **服务未运行**：

   ```bash
   sudo systemctl status auditd
   sudo journalctl -u auditd    # 查看服务启动日志
   ```

2. **权限不足**：
   - 确保用户属于 `adm` 组（可读日志）：

     ```bash
     sudo usermod -aG adm your_user
     ```

3. **规则未生效**：
   - 检查规则加载状态：

     ```bash
     sudo auditctl -l | grep login
     ```

---

## **九、附录：关键日志字段说明**

| 字段名        | 含义                          | 示例值               |
|---------------|-------------------------------|----------------------|
| `auid`        | 审计用户ID（登录时分配）      | `auid=1000`          |
| `uid`         | 当前进程用户ID                | `uid=0`（root）      |
| `ses`         | 会话ID                        | `ses=1234`           |
| `msg=audit()` | 时间戳（Unix 时间）           | `audit(1620000000.123)` |

---

通过以上配置，您可实现：

- **实时监控用户登录时间与持续时间**
- **统计长期未登录用户**
- **审计日志的安全存储与轮转**



如需进一步集成 SIEM 系统（如 ELK、Splunk），可配置 Auditd 将日志转发至远程服务器 。

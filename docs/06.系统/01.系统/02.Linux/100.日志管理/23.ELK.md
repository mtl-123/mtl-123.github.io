---
title: 4.ELK
date: 2025-06-06 10:51:32
permalink: /pages/1ed941/
categories:
  - 系统
  - 系统
  - Linux
  - 日志管理
tags:
  - ELK
author:
  name: MeiChen
  link: https://github.com/mtl-123
---

# ELK Stack 搭建完整指南（Elasticsearch + Logstash + Kibana）

- 版本信息

✅ 支持版本：ELK 9.0.0

✅ 支持系统：Ubuntu、CentOS

✅ 包含配置、安全设置、服务启动、日志收集示例

## 一、基础环境要求

```bash
# 系统资源要求
- 内存 ≥ 4GB（生产建议 ≥ 31GB）
- CPU ≥ 2核
- 磁盘 ≥ 10GB
- 内核版本 ≥ 3.5

# 必备依赖
# Red Hat/CentOS/Fedora
sudo yum install -y libtool-ltdl libffi unzip java-17-openjdk \
  curl net-tools iproute tcpdump bind-utils \
  xz gzip policycoreutils-python-utils \
  rsyslog logrotate sysstat firewalld \
  openssl unixODBC-devel proj-epsg

# Debian/Ubuntu
sudo apt install -y libtool-ltdl libffi-dev unzip openjdk-17-jdk \
  curl net-tools iproute2 tcpdump dnsutils \
  xz-utils gzip selinux-utils \
  rsyslog logrotate sysstat ufw \
  openssl unixodbc-dev proj-data
```

## 二、安装部署流程

### 1. 下载与解压

```bash
# 下载软件包
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-9.0.0-linux-x86_64.tar.gz

# 校验完整性（推荐）
shasum -a 512 elasticsearch-9.0.0-linux-x86_64.tar.gz

# 解压部署
tar zxpf elasticsearch-9.0.0-linux-x86_64.tar.gz
mv elasticsearch-9.0.0 /opt/elasticsearch
ln -s /opt/elasticsearch /usr/local/elasticsearch
ln -sf /usr/local/elasticsearch/bin/elasticsearch  /usr/local/bin/elasticsearch

chmod +x /usr/local/elasticsearch/bin/elasticsearch*
# 赋予执行权限
sudo chmod +x /usr/local/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller
```

### 2. 创建专用账户

```bash
# 创建受限用户
useradd -m -s /bin/bash -c "Elasticsearch User" es

# 权限分配
chown -R es:es /opt/elasticsearch
find /opt/elasticsearch -type d -exec chmod 750 {} \;
find /opt/elasticsearch -type f -exec chmod 640 {} \;

# 创建数据目录（若需自定义）
mkdir -p /data/elasticsearch
chown -R es:es /data/elasticsearch
```

### 3. 系统参数配置

```bash
# 修改内存锁定限制
echo "es soft memlock unlimited" >> /etc/security/limits.conf
echo "es hard memlock unlimited" >> /etc/security/limits.conf

# 修改文件描述符
echo "es soft nofile 65536" >> /etc/security/limits.conf
echo "es hard nofile 65536" >> /etc/security/limits.conf

# 激活配置
su - es -c "ulimit -l"
```

# 为 JDK 添加可执行权限

```bash
sudo chmod +x /usr/local/elasticsearch/bin/elasticsearch-certutil
```

### 4. 安全证书生成

```bash
# 生成自签名 CA 证书
sudo -u es /usr/local/elasticsearch/bin/elasticsearch-certutil ca --pem --out /usr/local/elasticsearch/config/certs/ca.tar.gz

# 创建存放目录
mkdir -p /usr/local/elasticsearch/config/certs/ca

# 解压 CA 证书
zunip /usr/local/elasticsearch/config/certs/ca.tar.gz -d /usr/local/elasticsearch/config/certs/ca/

# 确认文件已存在
ls -l /usr/local/elasticsearch/config/certs/ca/
# 目录结构
tree ca
ca
├── ca.crt
└── ca.key

1 directory, 2 files


# 使用已有 CA 证书签发节点证书
su - es -c "/usr/local/elasticsearch/bin/elasticsearch-certutil cert \
  --ip 192.168.10.179 \
  --name elasticsearch \
  --dns localhost,elasticsearch \
  --pem \
  --ca-cert /usr/local/elasticsearch/certs/ca/ca/ca.crt \
  --ca-key /usr/local/elasticsearch/certs/ca/ca/ca.key \
  --out /usr/local/elasticsearch/certs/cluster-certificates.tar.gz"



# 权限加固
mkdir -p /usr/local/elasticsearch/certs/elasticsearch
unzip /usr/local/elasticsearch/certs/cluster-certificates.tar.gz -d /tmp/es-certs/
chown -R es:es /usr/local/elasticsearch/certs

# 拷贝节点证书和私钥
cp /tmp/es-certs/elasticsearch/*.crt /usr/local/elasticsearch/certs/elasticsearch/
cp /tmp/es-certs/elasticsearch/*.key /usr/local/elasticsearch/certs/elasticsearch/

chown -R es:es /usr/local/elasticsearch/config/certs
find /usr/local/elasticsearch/config/certs -type f -exec chmod 600 {} \;
find /usr/local/elasticsearch/config/certs -type d -exec chmod 750 {} \;
```

### 5. 核心配置

```yaml

sudo -u es vim  /usr/local/elasticsearch/config/elasticsearch.yml

cluster.name: my-cluster
node.name: node-1
network.host: 0.0.0.0
http.port: 9200
discovery.type: single-node
path.data: /data/elasticsearch
path.logs: /opt/elasticsearch/logs

# TLS配置
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.key: certs/elasticsearch/elasticsearch.key
xpack.security.transport.ssl.certificate: certs/elasticsearch/elasticsearch.crt
xpack.security.transport.ssl.certificate_authorities: certs/ca/ca.crt

xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.key: certs/elasticsearch/elasticsearch.key
xpack.security.http.ssl.certificate: certs/elasticsearch/elasticsearch.crt
xpack.security.http.ssl.certificate_authorities: certs/ca/ca.crt
```

### 6. JVM参数优化（生产建议）

```bash
sudo -u es vim  /usr/local/elasticsearch/config/jvm.options

-Xms3g
-Xmx3g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
```

### 内核参数优化

- 无需额外安装软件包，但需配置以下内核参数：

```bash
# 临时生效
sudo sysctl -w vm.max_map_count=262144
sudo sysctl -w fs.file-max=65536

# 永久生效（写入配置文件）
echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf
echo "fs.file-max=65536" | sudo tee -a /etc/sysctl.conf
```

## 三、服务管理配置

### 1. systemd服务单元

```ini
vim  /etc/systemd/system/elasticsearch.service
[Unit]
Description=Elasticsearch 9.0.0
Documentation=https://www.elastic.co/documentation/elasticsearch
After=network.target

[Service]
User=es
Group=es
Environment="ES_HOME=/usr/local/elasticsearch"
Environment="ES_PATH_CONF=/usr/local/elasticsearch/config"
ExecStart=/usr/local/elasticsearch/bin/elasticsearch
Restart=always
LimitMEMLOCK=infinity
LimitNOFILE=65536
TimeoutStopSec=15

[Install]
WantedBy=multi-user.target
```

### 2. 服务管理命令

```bash
systemctl daemon-reload
systemctl enable elasticsearch --now

systemctl start elasticsearch
systemctl status elasticsearch

# 查看日志
journalctl -u elasticsearch.service -f
```

## 四、安全验证

### 1. 初始密码设置

```bash
# 首次启动需初始化密码
sudo -u es /usr/local/elasticsearch/bin/elasticsearch-setup-passwords auto -u https://localhost:9200
******************************************************************************
Note: The 'elasticsearch-setup-passwords' tool has been deprecated. This       command will be removed in a future release.
******************************************************************************

Initiating the setup of passwords for reserved users elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.
The passwords will be randomly generated and printed to the console.
Please confirm that you would like to continue [y/N]y


Changed password for user apm_system
PASSWORD apm_system = IDpX71NI4LVJjUuyVaQc

Changed password for user kibana_system
PASSWORD kibana_system = kdVLYlqQ6oYow717pW2m

Changed password for user kibana
PASSWORD kibana = kdVLYlqQ6oYow717pW2m

Changed password for user logstash_system
PASSWORD logstash_system = n6DDc930yv9DvMSwdWym

Changed password for user beats_system
PASSWORD beats_system = 7cIfEKE865qdhxTOVOqL

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = OToFV6sRUObYycQvQ6Y6
# elastic 用户密码
Changed password for user elastic
PASSWORD elastic = jEJh7JPWx82u9vKJ2NO1
```

### 2. 健康检查

```bash
# 使用生成的elastic用户密码访问
curl -k -u elastic https://localhost:9200/_cluster/health?pretty
```

## 五、常见问题修复

### 1. 证书路径错误

**症状**：`java.lang.IllegalStateException: failed to load SSL configuration`

```bash
# 修复方法
ls /usr/local/elasticsearch/certs/
# 应包含：
# ├── ca
# │   └── ca.crt
# └── elasticsearch
#     ├── elasticsearch.crt
#     └── elasticsearch.key
```

### 2. 内存锁定失败

**症状**：`Unable to lock JVM memory`

```bash
# 修复方法
sysctl -w vm.max_map_count=262144
# 永久生效：
echo "vm.max_map_count=262144" >> /etc/sysctl.conf
```

### 3. 端口访问失败

```bash
# 开放防火墙
firewall-cmd --permanent --add-port=9200/tcp
firewall-cmd --permanent --add-port=9300/tcp
firewall-cmd --reload
```

## 六、目录结构说明

```
/opt/elasticsearch/          # 主程序目录
├── bin/                     # 可执行文件
├── config/                  # 配置文件
├── certs/                   # 安全证书
├── data/                    # 数据目录（软链至/data）
├── logs/                    # 日志目录
└── modules/                 # 模块文件
```

## 七、生产环境注意事项

1. **安全加固**：定期轮换证书，禁用单节点发现模式
2. **备份策略**：配置快照仓库，定期执行集群快照
3. **监控体系**：集成Prometheus+Grafana监控指标
4. **升级机制**：保留旧版本二进制文件用于回滚

---

此文档修复了以下关键问题：

1. 补充完整的系统参数配置
2. 修正证书生成和路径配置
3. 完善systemd服务单元文件
4. 增加JVM参数优化建议
5. 补充初始密码设置流程
6. 添加常见问题修复方案
7. 规范权限和安全策略
8. 明确生产环境注意事项

# Kibana

## 下载 Kibana

```bash
KIBANA_VERSION="9.0.0"
https://artifacts.elastic.co/downloads/kibana/kibana-${KIBANA_VERSION}-linux-x86_64.tar.gz
tar -xf kibana-${KIBANA_VERSION}-linux-x86_64.tar.gz
mv kibana-9.0.0 /opt/
mv  /opt/kibana-9.0.0/ /opt/kibana
ln -sf /opt/kibana-9.0.0/ /usr/local/\
ln -s /usr/local/kibana-9.0.0/bin/* /usr/local/bin/
chmod +x /usr/local/bin/*
ls -la /usr/local/bin

```

## 创建专用用户运行Kibana

```bash
useradd -m -s /bin/bash kibana
chown -R kibana:kibana /opt/kibana
```

## 准备证书文件（复用 Elasticsearch 的 CA 证书）

```bash
mkdir -p /usr/local/kibana/config/certs/ca
cp /usr/local/elasticsearch/config/certs/ca/ca.crt /usr/local/kibana/config/certs/ca/

# 设置权限
chown -R kibana:kibana /usr/local/kibana/config/certs
chmod 600 /usr/local/kibana/config/certs/ca/ca.crt
find /usr/local/kibana/config/certs -type f -exec chmod 600 {} \;
find /usr/local/kibana/config/certs -type d -exec chmod 750 {} \;

```

## 配置

```bash

cat  /usr/local/kibana/config/kibana.yml | grep -v ^# | grep  -v ^$
# 地址配置
server.port: 5601
server.host: "0.0.0.0"
server.publicBaseUrl: "https://192.168.10.179:5601"
server.name: "kibana-node"
# 证书配置
server.ssl.enabled: true
server.ssl.certificate: /usr/local/kibana/config/certs/elasticsearch/elasticsearch.crt
server.ssl.key: /usr/local/kibana/config/certs/elasticsearch/elasticsearch.key
elasticsearch.hosts: ["https://localhost:9200"]
elasticsearch.ssl.certificateAuthorities: [ "/usr/local/kibana/config/certs/ca/ca.crt" ]
elasticsearch.ssl.verificationMode: certificate
# 日志配置
logging.appenders.default:
  type: rolling-file
  fileName: /opt/kibana/logs/kibana.log
  policy:
    type: size-limit
    size: 256mb
  strategy:
    type: numeric
    max: 10
  layout:
    type: json
logging.loggers:
  - name: root
    level: info
  - name: elasticsearch.query
    level: warn
  - name: http.server.response
    level: warn
  - name: metrics.ops
    level: warn
i18n.locale: "zh-CN"


```

## 创建日志目录并授权

```bash
mkdir -p /opt/kibana/logs
chown -R kibana:kibana /opt/kibana/logs
```

## 启动

```bash

# 在 Elasticsearch 节点上执行
# 已kibana 用户启动
sudo -u kibana /usr/local/kibana/bin/kibana

# 已root用户启动
kibana --allow-root

# 浏览器访问
http://localhost:5601

# 提示输入用户密码，是上面的 elasticsearch 生成的密码
Changed password for user kibana_system #用户
PASSWORD kibana_system = kdVLYlqQ6oYow717pW2m # 密码
# 然后勾选信任后， kibana --allow-root 执行后的终端上面有验证码输入即可（例如下所示）

i Kibana has not been configured.

Go to http://localhost:5601/?code=887090 to get started.

Your verification code is:  887 090  #（ 这里的887090 输入到web上面）

```

## 创建开机自启动

```bash
sudo vim /etc/systemd/system/kibana.service

[Unit]
Description=Kibana 9.0.0
After=network.target

[Service]
User=kibana
Group=kibana
ExecStart=/usr/local/kibana/bin/kibana
Restart=always
Environment="NODE_OPTIONS=--no-warnings"

[Install]
WantedBy=multi-user.target
```

## 服务操作

```bash
sudo systemctl daemon-reload
sudo systemctl enable kibana --now
sudo systemctl start kibana
sudo systemctl status kibana

# 查看日志
journalctl -u kibana.service -f
```

## 测试访问
`https://localhost:5601`


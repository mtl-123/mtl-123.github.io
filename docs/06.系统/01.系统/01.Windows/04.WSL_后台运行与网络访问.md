---
title: WSL_后台运行与网络访问
date: 2025-06-03 16:15:26
permalink: /pages/f6c3e3/
categories:
  - 系统
  - 系统
  - Windows
tags:
  - WSL_后台运行与网络访问
author:
  name: MeiChen
  link: https://github.com/mtl-123
---

---


# ⚙️ WSL 后台运行与网络访问配置指南

> 💡 本文档讲解如何让 WSL 在后台持续运行，并实现从局域网访问 WSL 内部服务。

---

## 第一章：保持 WSL 在后台持续运行

> 📌 当退出终端后，WSL 可能会自动关闭，导致 SSH 或其他服务中断。

### 1.1 解决方案概述

为了让 WSL 持续运行，我们采用 `.vbs` 脚本在系统启动时自动运行一个 WSL 终端进程，防止 WSL 因无活动进程而关闭。

---

### 1.2 创建后台运行脚本

#### 文件名：`start-wsl-background.vbs`

```vbs
Set objShell = CreateObject("WScript.Shell")
objShell.Run "cmd /c wsl", 0, False
```

📌 **说明：**

- `cmd /c wsl`：执行一次 `wsl` 命令，进入默认发行版
- `0`：表示窗口隐藏运行
- `False`：不等待脚本执行完成

---

### 1.3 设置开机自启动

1. 按下 `Win + R` 输入 `shell:startup` 打开“启动”文件夹
2. 将上述 `.vbs` 文件复制到该文件夹中

✅ **效果：**
- Windows 开机后自动静默运行 WSL
- 即使关闭终端，WSL 也不会退出

---

## 第二章：让宿主机及局域网访问 WSL 中的服务

> 💡 示例：你在 WSL 中运行了一个 Python HTTP 服务监听在 `8000` 端口，如何让局域网访问？

---

### 2.1 在 WSL 中启动服务

```bash
nohup python3 -m http.server 8000 &
```

---

### 2.2 获取 WSL 的 IP 地址

```bash
hostname -I
```

假设输出为：

```
172.27.250.42
```

---

## 第三章：配置 Windows 端口转发（Port Proxy）

---

### 3.1 获取 WSL 网卡名称

在 PowerShell 中执行：

```powershell
ipconfig /all
```

找到类似如下信息：

```
以太网适配器 vEthernet (WSL (Hyper-V firewall)):

   IPv4 地址 . . . . . . . . . . . . : 172.27.240.1(首选)
```

---

### 3.2 添加防火墙规则允许访问

管理员身份打开 PowerShell 并执行：

```powershell
New-NetFirewallRule -DisplayName "WSL" -Direction Inbound -InterfaceAlias "vEthernet (WSL (Hyper-V firewall))" -Action Allow
```

---

### 3.3 【新增】检查宿主机端口是否被占用（非常重要！）

在添加 Port Proxy 规则前，必须确保你选择的 `listenport`（如 `8000`）没有被 Windows 上的程序占用。

#### 方法一：使用 `netstat` 查看端口占用情况

```powershell
netstat -ano | findstr :8000
```

如果输出为空，则说明端口未被占用，可以使用。

如果输出类似：

```
TCP    0.0.0.0:8000           0.0.0.0:0              LISTENING       1234
```

说明端口已被占用，你可以查看 PID `1234` 是哪个程序：

```powershell
tasklist | findstr 1234
```

---

### 3.4 配置端口转发（Port Proxy）

确认端口可用后执行：

```powershell
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8000 connectaddress=172.27.250.42 connectport=8000
```

---

### 3.5 查看当前 Port Proxy 规则

```powershell
netsh interface portproxy show all
```

输出示例：

```
侦听 ipv4:                 连接到 ipv4:

地址            端口        地址            端口
--------------- ----------  --------------- ----------
0.0.0.0         22          172.20.146.51   22
0.0.0.0         8000        172.27.250.42   8000
```

---

### 3.6 删除某个 Port Proxy 规则（如需）

```powershell
netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=8000
```

---

### 3.7 批量添加多个端口转发规则（推荐）

你可以创建一个 PowerShell 脚本文件来一次性添加多个服务端口。

#### 示例脚本：`setup-portproxy.ps1`

```powershell
# 先清除旧规则（可选）
# netsh interface portproxy reset all

# 添加多个端口转发规则
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=80    connectaddress=172.27.250.42 connectport=80
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=22    connectaddress=172.27.250.42 connectport=22
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=3306  connectaddress=172.27.250.42 connectport=3306
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8080  connectaddress=172.27.250.42 connectport=8080
```

📌 **使用方式：**

1. 将上述内容保存为 `setup-portproxy.ps1`
2. 右键 → “以管理员身份运行”

---

### 3.8 设置脚本开机自启（可选但推荐）

#### 方法：放入“启动”文件夹

1. 按下 `Win + R` 输入 `shell:startup` 打开“启动”文件夹
2. 创建快捷方式指向你的 `.ps1` 脚本，例如：

```text
PowerShell.exe -ExecutionPolicy Bypass -File "C:\scripts\setup-portproxy.ps1"
```

📌 **注意：**
- 确保路径正确
- 首次运行前建议测试脚本是否正常工作

---

## 第四章：验证服务是否可达

---

### 4.1 在宿主机上测试本地访问

```bash
telnet 127.0.0.1 8000
```

---

### 4.2 在局域网设备上测试访问

```bash
telnet <Windows宿主机IP> 8000
```

例如：

```bash
telnet 192.168.10.10 8000
```

如果连接成功，说明服务已开放！

---

## 附录 A：常用命令汇总

| 操作 | 命令 |
|------|------|
| 获取 WSL IP 地址 | `hostname -I` |
| 添加防火墙规则 | `New-NetFirewallRule -DisplayName "WSL" ...` |
| 添加端口转发 | `netsh interface portproxy add v4tov4 ...` |
| 查看所有转发规则 | `netsh interface portproxy show all` |
| 删除指定转发规则 | `netsh interface portproxy delete v4tov4 ...` |
| 测试端口连通性 | `telnet <IP> <Port>` |
| 查看端口占用情况 | `netstat -ano \| findstr :<Port>` |
| 查看进程 ID 对应程序 | `tasklist \| findstr <PID>` |

---

## 附录 B：完整脚本模板下载

你可以将以下内容分别保存为：

- `start-wsl-background.vbs`：用于开机自动运行 WSL
- `setup-portproxy.ps1`：用于配置多个端口转发规则

### ✅ `start-wsl-background.vbs`

```vbs
Set objShell = CreateObject("WScript.Shell")
objShell.Run "cmd /c wsl", 0, False
```

### ✅ `setup-portproxy.ps1`

```powershell
# 添加多个端口转发规则
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=80    connectaddress=172.27.250.42 connectport=80
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=22    connectaddress=172.27.250.42 connectport=22
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=3306  connectaddress=172.27.250.42 connectport=3306
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8080  connectaddress=172.27.250.42 connectport=8080
```

---

如果你希望我帮你生成完整的 ZIP 包或 PDF 格式文档，或者你想将这些脚本封装成一键安装包，请告诉我：

- WSL 的实际 IP 地址
- 你常用的端口号列表（如 80, 22, 3306, 8080 等）

我可以为你定制完整部署工具 👇
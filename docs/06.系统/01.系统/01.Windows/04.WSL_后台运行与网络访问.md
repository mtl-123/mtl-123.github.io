---
title: WSL_后台运行与网络访问
date: 2025-06-03 16:15:26
permalink: /pages/f6c3e3/
categories:
  - 系统
  - 系统
  - Windows
tags:
  - WSL_后台运行与网络访问
author:
  name: MeiChen
  link: https://github.com/mtl-123
---


## ✅ 文档目标

帮助用户实现以下目标：

- 保持 WSL 在后台持续运行（即使关闭终端）
- 实现局域网访问 WSL 中的服务
- 确保配置逻辑清晰、操作可验证、流程完整

---

# 📚 WSL 后台运行与网络访问配置手册

> 💡 本文档旨在指导 Windows 用户配置 WSL2 子系统，实现服务后台常驻运行，并通过局域网访问其内部服务。

---

## 第一章：需求背景

### 1.1 问题描述

- WSL 默认在没有活动进程时会自动关闭
- 导致 SSH、Web 服务等无法长期运行
- 局域网设备无法直接访问 WSL 中的服务

### 1.2 需求目标

| 目标 | 描述 |
|------|------|
| ✅ 持续运行 | 即使关闭终端，WSL 仍持续运行 |
| ✅ 本地访问 | 宿主机可以通过 IP + 端口访问服务 |
| ✅ 局域网访问 | 同一局域网的其他设备也能访问该服务 |

---

## 第二章：实现原理

### 2.1 WSL 运行机制

- WSL2 是一个基于 Hyper-V 的轻量级虚拟机
- 当没有活跃进程时，整个 Linux 子系统会被终止（相当于关机）

### 2.2 网络架构

```
[局域网设备] —— (TCP/IP) —— [Windows 宿主机] —— (NAT) —— [WSL2 子系统]
```

- WSL2 有私有 IP（如 `172.x.x.x`）
- Windows 宿主机作为 NAT 网关
- 外部访问需要借助 Port Proxy 和防火墙规则

---

## 第三章：解决方案概述

| 模块 | 解决方案 |
|------|----------|
| 后台运行 | 使用 `.vbs` 脚本开机启动 WSL 终端进程 |
| 本地访问 | 使用 `netsh interface portproxy` 映射端口 |
| 局域网访问 | 添加防火墙入站规则允许外部访问 |

---

## 第四章：详细配置步骤

---

### 4.1 持续运行 WSL（后台常驻）

#### 4.1.1 创建后台脚本文件

文件名：`start-wsl-background.vbs`

```vbs
Set objShell = CreateObject("WScript.Shell")
objShell.Run "cmd /c wsl", 0, False
```

📌 **说明：**

- `cmd /c wsl`：执行一次 `wsl` 命令，进入默认发行版
- `0`：表示窗口隐藏运行
- `False`：不等待脚本执行完成

#### 4.1.2 设置开机自启动

1. 按下 `Win + R` 输入 `shell:startup` 打开“启动”文件夹
2. 将上述 `.vbs` 文件复制到该文件夹中

✅ **效果：**

- Windows 开机后自动静默运行 WSL
- 即使关闭终端，WSL 也不会退出

---

### 4.2 获取 WSL 的 IP 地址

在 WSL 中执行：

```bash
hostname -I
```

输出示例：

```
172.27.250.42
```

📌 **用途：**

- 用于后续配置端口转发的目标地址

---

### 4.3 配置端口转发（Port Proxy）

#### 4.3.1 检查宿主机端口是否被占用

```powershell
netstat -ano | findstr :8000
```

如果输出为空，则端口可用；否则更换端口号。

#### 4.3.2 添加 Port Proxy 规则

```powershell
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8000 connectaddress=172.27.250.42 connectport=8000
```

📌 **参数说明：**

| 参数 | 含义 |
|------|------|
| `listenaddress` | 宿主机监听地址（0.0.0.0 表示所有接口） |
| `listenport` | 宿主机对外暴露的端口 |
| `connectaddress` | WSL 子系统的 IP 地址 |
| `connectport` | WSL 子系统中的服务端口 |

#### 4.3.3 查看当前 Port Proxy 规则

```powershell
netsh interface portproxy show all
```

---

### 4.4 允许外部访问（添加防火墙规则）

管理员身份打开 PowerShell 并执行：

```powershell
New-NetFirewallRule -DisplayName "Allow TCP Port 8000" `
    -Direction Inbound -Protocol TCP -LocalPort 8000 -Action Allow -Profile Any
```

📌 **作用：**

- 允许外部设备通过 TCP 协议访问本机的 `8000` 端口
- 对应于局域网内设备访问宿主机的 IP + 端口

---

### 4.5 自动化脚本模板（推荐）

#### 示例脚本：`setup-portproxy.ps1`

```powershell
# 设置转发端口（请根据需要修改）
$ListenPort = 8000
$ConnectIP = "172.27.250.42"
$ConnectPort = 8000

# 添加 Port Proxy 规则
netsh interface portproxy add v4tov4 `
    listenaddress=0.0.0.0 `
    listenport=$ListenPort `
    connectaddress=$ConnectIP `
    connectport=$ConnectPort

# 添加防火墙入站规则
New-NetFirewallRule -DisplayName "Allow TCP Port $ListenPort" `
    -Protocol TCP -LocalPort $ListenPort `
    -Action Allow -Profile Any

Write-Host "✅ 已添加 Port Proxy 和防火墙规则，端口: $ListenPort"
```

📌 **使用方式：**

- 右键 → “以管理员身份运行”

---

### 4.6 设置脚本开机自启（可选但推荐）

1. 按下 `Win + R` 输入 `shell:startup` 打开“启动”文件夹
2. 创建快捷方式指向你的 `.ps1` 脚本，例如：

```text
PowerShell.exe -ExecutionPolicy Bypass -File "C:\scripts\setup-portproxy.ps1"
```

📌 **注意：**

- 确保路径正确
- 首次运行前建议测试脚本是否正常工作

---

## 第五章：验证服务是否可达

### 5.1 在宿主机上测试本地访问

```bash
telnet 127.0.0.1 8000
```

### 5.2 在局域网设备上测试访问

```bash
telnet <宿主机IP> 8000
```

例如：

```bash
telnet 192.168.1.100 8000
```

✅ **预期结果：**

- 成功连接并看到 HTTP 服务响应或文件列表

---

## 附录 A：常用命令汇总

| 操作 | 命令 |
|------|------|
| 获取 WSL IP 地址 | `hostname -I` |
| 添加 Port Proxy 规则 | `netsh interface portproxy add ...` |
| 查看 Port Proxy 列表 | `netsh interface portproxy show all` |
| 删除 Port Proxy 规则 | `netsh interface portproxy delete ...` |
| 添加防火墙规则 | `New-NetFirewallRule ...` |
| 查看端口占用情况 | `netstat -ano \| findstr :<Port>` |
| 查看进程 ID 对应程序 | `tasklist \| findstr <PID>` |
| 测试本地访问 | `telnet 127.0.0.1 <Port>` |
| 测试局域网访问 | `telnet <宿主机IP> <Port>` |

---

## 附录 B：完整脚本模板下载

你可以将以下内容分别保存为：

- `start-wsl-background.vbs`：用于开机自动运行 WSL
- `setup-portproxy.ps1`：用于配置多个端口转发规则

### ✅ `start-wsl-background.vbs`

```vbs
Set objShell = CreateObject("WScript.Shell")
objShell.Run "cmd /c wsl", 0, False
```

### ✅ `setup-portproxy.ps1`

```powershell
# 添加多个端口转发规则
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=80    connectaddress=172.27.250.42 connectport=80
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=22    connectaddress=172.27.250.42 connectport=22
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=3306  connectaddress=172.27.250.42 connectport=3306
netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=8080  connectaddress=172.27.250.42 connectport=8080
```

---

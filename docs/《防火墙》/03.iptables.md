---
title: iptables
date: 2025-05-07 13:40:19
permalink: /pages/c0dd9c/
categories:
  - ã€Šé˜²ç«å¢™ã€‹
tags:
  - iptables
author:
  name: MeiChen
  link: https://github.com/mtl-123
---



# iptables é…ç½®ä¸ç®¡ç†æŒ‡å—

## ç®€ä»‹

`iptables`æ˜¯Linuxå†…æ ¸ä¸­ç”¨äºå®ç°ç½‘ç»œåŒ…è¿‡æ»¤å’ŒNATåŠŸèƒ½çš„å·¥å…·ã€‚æœ¬æŒ‡å—å°†ä»‹ç»å¦‚ä½•å®‰è£…ã€é…ç½®ã€ç®¡ç†å’Œä¼˜åŒ–`iptables`ã€‚

## å®‰è£…

åœ¨Red Hatç³»åˆ—å’Œubuntuç³»åˆ—ç³»ç»Ÿä¸Šå®‰è£…`iptables`:

<code-group>
  <code-block title="apt" active>

```bash
sudo apt-get update
sudo apt-get install iptables-persistent -y
```

  </code-block>

  <code-block title="yum">
```bash
sudo yum install iptables-services
```
  </code-block>
</code-group>

## å¯åŠ¨ä¸åœæ­¢

å¯åŠ¨`iptables`æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼š

```bash
sudo systemctl start iptables
sudo systemctl enable iptables
```

åœæ­¢`iptables`æœåŠ¡ï¼š

```bash
sudo systemctl stop iptables
```

## çŠ¶æ€æ£€æŸ¥

æ£€æŸ¥`iptables`æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š

```bash
sudo systemctl status iptables
```

æŸ¥çœ‹å½“å‰æ‰€æœ‰è§„åˆ™ï¼š

```bash
sudo iptables -L -v -n
```

## åŸºæœ¬é…ç½®

### è®¾ç½®é»˜è®¤ç­–ç•¥

è®¾ç½®é»˜è®¤ç­–ç•¥ä¸ºæ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡ï¼Œå…è®¸æ‰€æœ‰å‡ºç«™æµé‡ï¼š

```bash
sudo iptables -P INPUT DROP
sudo iptables -P OUTPUT ACCEPT
sudo iptables -P FORWARD DROP
```

### æŸ¥çœ‹è§„åˆ™

åˆ—å‡ºå½“å‰æ¿€æ´»çš„æ‰€æœ‰è§„åˆ™ï¼š

```bash
sudo iptables -L -v -n
```

## ç«¯å£ç®¡ç†

### å¼€æ”¾å•ä¸ªç«¯å£

æ°¸ä¹…æ€§å¼€æ”¾HTTP(80/tcp)ç«¯å£ï¼š

```bash
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo service iptables save
```

### å¼€æ”¾å¤šä¸ªç«¯å£

ä¸€æ¬¡æ€§å¼€æ”¾å¤šä¸ªç«¯å£ï¼Œå¦‚HTTP(80/tcp)å’ŒHTTPS(443/tcp)ï¼š

```bash
sudo iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT
sudo service iptables save
```

### ç§»é™¤ç«¯å£

ç§»é™¤ç‰¹å®šç«¯å£è§„åˆ™ï¼ˆå‡è®¾ç«¯å£å·ä¸º80ï¼‰ï¼š

é¦–å…ˆæ‰¾åˆ°è¦åˆ é™¤è§„åˆ™çš„è¡Œå·ï¼š

```bash
sudo iptables -L --line-numbers
```

ç„¶åæ ¹æ®è¡Œå·åˆ é™¤è§„åˆ™ï¼ˆä¾‹å¦‚ï¼Œç¬¬3è¡Œï¼‰ï¼š

```bash
sudo iptables -D INPUT 3
sudo service iptables save
```

## æœåŠ¡ç®¡ç†

### å¼€æ”¾æœåŠ¡

å…è®¸SSHæœåŠ¡ï¼š

```bash
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo service iptables save
```

### é™åˆ¶æœåŠ¡è®¿é—®

ä»…å…è®¸æ¥è‡ªç‰¹å®šIPåœ°å€çš„SSHè¿æ¥ï¼ˆ192.168.1.100ï¼‰ï¼š

```bash
sudo iptables -A INPUT -p tcp -s 192.168.1.100 --dport 22 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 22 -j DROP
sudo service iptables save
```

## ä¼˜åŒ–ä¸å®‰å…¨ç­–ç•¥

### æœ€å°æƒé™åŸåˆ™

åªå¼€æ”¾å¿…è¦çš„ç«¯å£å’ŒæœåŠ¡ï¼Œç¡®ä¿å®‰å…¨æ€§æœ€å¤§åŒ–ã€‚

### æ—¥å¿—è®°å½•

å¯ç”¨æ—¥å¿—è®°å½•åŠŸèƒ½æ¥ç›‘æ§æµé‡ï¼š

```bash
sudo iptables -A INPUT -j LOG --log-prefix "IPTABLES-DROP: " --log-level 4
```

## é«˜çº§é…ç½®

### å¯Œè§„åˆ™é…ç½®

åˆ›å»ºå¤æ‚çš„æ¡ä»¶è§„åˆ™ï¼Œä¾‹å¦‚åŸºäºæºIPæˆ–æ—¶é—´çš„è§„åˆ™ã€‚ç”±äº`iptables`æœ¬èº«ä¸æ”¯æŒæ—¶é—´è§„åˆ™ï¼Œæ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨é¢å¤–çš„æ¨¡å—å¦‚`xt_time`ã€‚

### ç›´æ¥è§„åˆ™é…ç½®

ç›´æ¥ç¼–è¾‘iptablesè§„åˆ™ä»¥å®ç°æ›´ç²¾ç»†çš„æ§åˆ¶ã€‚

## å¤‡ä»½ä¸æ¢å¤

å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶ä»¥é˜²æ­¢æ„å¤–ä¸¢å¤±ï¼š

```bash
sudo iptables-save > /path/to/rules.backup
```

æ¢å¤æ—¶å¯ä»¥é‡æ–°å¯¼å…¥è¿™äº›è§„åˆ™ï¼š

```bash
sudo iptables-restore < /path/to/rules.backup
```

---

### æ¡ˆä¾‹ï¼šä¿æŠ¤WebæœåŠ¡å™¨

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªWebæœåŠ¡å™¨éœ€è¦å¯¹å¤–æä¾›HTTPå’ŒHTTPSæœåŠ¡ï¼Œä½†è¦é™åˆ¶SSHåªå¯¹ç‰¹å®šIPå¼€æ”¾ï¼š

#### ç¤ºä¾‹ï¼šå¼€æ”¾HTTPå’ŒHTTPS

```bash
sudo iptables -A INPUT -p tcp -m multiport --dports 80,443 -j ACCEPT
sudo service iptables save
```

#### ç¤ºä¾‹ï¼šé™åˆ¶SSHè®¿é—®

ä»…å…è®¸æ¥è‡ª192.168.1.100çš„SSHè¿æ¥ï¼š


## iptables é˜²ç«å¢™ç®¡ç†è„šæœ¬

vim iptables.sh

```bash
#!/bin/bash

# =============== å¸¸é‡å®šä¹‰ ===============
readonly LOG_PREFIX="SEC_FW"
readonly BAK_DIR="/etc/firewall/backup"
readonly DATE=$(date +"%Y%m%d%H%M")

# =============== æ£€æŸ¥rootæƒé™ ===============
if [ "$(id -u)" != "0" ]; then
   echo "âŒ é”™è¯¯ï¼šè¯·ä»¥rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
   exit 1
fi

# =============== è·å–å½“å‰SSHè¿æ¥IP ===============
function get_ssh_ip {
    # ä¼˜å…ˆä½¿ç”¨SSH_CLIENTç¯å¢ƒå˜é‡ï¼ˆæ›´å¯é ï¼‰
    local ip=$(echo ${SSH_CLIENT} | awk '{print $1}')
    if [[ -z "$ip" ]]; then
        # å›é€€ä½¿ç”¨whoå‘½ä»¤
        ip=$(who am i | awk '{print $5}' | tr -d '()')
    fi
    echo "$ip"
}

# =============== åˆ é™¤é‡å¤è§„åˆ™ ===============
function delete_duplicate_rules {
    local chain="$1"
    shift
    local rule="$@"
    
    while iptables -C "$chain" $rule 2>/dev/null; do
        iptables -D "$chain" $rule
    done
}

# =============== è®¾ç½®é»˜è®¤ç­–ç•¥ ===============
function set_default_policy {
    iptables -P INPUT DROP
    iptables -P FORWARD DROP
    iptables -P OUTPUT ACCEPT
    echo "âœ… é»˜è®¤ç­–ç•¥å·²è®¾ç½®ï¼šINPUT DROP, FORWARD DROP, OUTPUT ACCEPT"
}

# =============== å…è®¸åŸºç¡€æœåŠ¡ ===============
function allow_basic_services {
    iptables -I INPUT 1 -i lo -j ACCEPT
    iptables -I INPUT 2 -m state --state ESTABLISHED,RELATED -j ACCEPT
    echo "âœ… å·²æ”¾è¡Œæœ¬åœ°å›ç¯å’Œå·²å»ºç«‹è¿æ¥"
}

# =============== æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ ===============
function show_help {
    cat << EOF
ğŸ›¡ï¸ å®‰å…¨é˜²ç«å¢™ç®¡ç†è„šæœ¬ v1.2
ç”¨æ³•: $0 [é€‰é¡¹]...

åŸºç¡€åŠŸèƒ½ï¼š
  -h, --help                æ˜¾ç¤ºæ­¤å¸®åŠ©
  block-in <IP>             å°ç¦IPå…¥ç«™
  block-out <IP>            å°ç¦IPå‡ºç«™
  unblock-in <IP>           è§£å°IPå…¥ç«™
  unblock-out <IP>          è§£å°IPå‡ºç«™
  block-in-port <IP> <PORT> å°ç¦IPå…¥ç«™ç«¯å£
  block-out-port <IP> <PORT> å°ç¦IPå‡ºç«™ç«¯å£
  allow-in <IP>             å…è®¸IPå…¥ç«™
  allow-out <IP>            å…è®¸IPå‡ºç«™
  list                      åˆ—å‡ºè§„åˆ™
  save                      æŒä¹…åŒ–ä¿å­˜
  log-on                    å¼€å¯æ—¥å¿—
  log-off                   å…³é—­æ—¥å¿—
  setup-secure              åˆå§‹åŒ–å®‰å…¨ç­–ç•¥
  restore-backup            æ¢å¤å¤‡ä»½

ç¤ºä¾‹: 
  $0 allow-in 192.168.1.100
  $0 block-out-port 8.8.8.8 53
EOF
    exit 0
}

# =============== ä¸»é€»è¾‘ ===============
case "$1" in
    -h|--help)
        show_help
        ;;
    block-in)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPåœ°å€"
            exit 1
        fi
        delete_duplicate_rules INPUT "-s $2 -j DROP"
        iptables -A INPUT -s "$2" -j DROP
        echo "âœ… å·²å°ç¦IP $2 çš„å…¥ç«™è®¿é—®"
        ;;
    block-out)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPåœ°å€"
            exit 1
        fi
        delete_duplicate_rules OUTPUT "-d $2 -j DROP"
        iptables -A OUTPUT -d "$2" -j DROP
        echo "âœ… å·²å°ç¦IP $2 çš„å‡ºç«™è®¿é—®"
        ;;
    unblock-in)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPåœ°å€"
            exit 1
        fi
        delete_duplicate_rules INPUT "-s $2 -j DROP"
        echo "âœ… å·²è§£é™¤IP $2 çš„å…¥ç«™å°ç¦"
        ;;
    unblock-out)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPåœ°å€"
            exit 1
        fi
        delete_duplicate_rules OUTPUT "-d $2 -j DROP"
        echo "âœ… å·²è§£é™¤IP $2 çš„å‡ºç«™å°ç¦"
        ;;
    block-in-port)
        if [ -z "$2" ] || [ -z "$3" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPå’Œç«¯å£å·"
            exit 1
        fi
        # åŒæ—¶å°ç¦TCPå’ŒUDP
        for proto in tcp udp; do
            delete_duplicate_rules INPUT "-s $2 -p $proto --dport $3 -j DROP"
            iptables -A INPUT -s "$2" -p "$proto" --dport "$3" -j DROP
        done
        echo "âœ… å·²å°ç¦IP $2 çš„ TCP/UDP ç«¯å£ $3 å…¥ç«™"
        ;;
    block-out-port)
        if [ -z "$2" ] || [ -z "$3" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPå’Œç«¯å£å·"
            exit 1
        fi
        # ä¿®æ­£ï¼šå°ç¦ç›®æ ‡ç«¯å£è€Œéæºç«¯å£
        for proto in tcp udp; do
            delete_duplicate_rules OUTPUT "-d $2 -p $proto --dport $3 -j DROP"
            iptables -A OUTPUT -d "$2" -p "$proto" --dport "$3" -j DROP
        done
        echo "âœ… å·²å°ç¦IP $2 çš„ TCP/UDP ç«¯å£ $3 å‡ºç«™"
        ;;
    allow-in)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPåœ°å€"
            exit 1
        fi
        delete_duplicate_rules INPUT "-s $2 -j ACCEPT"
        iptables -I INPUT 1 -s "$2" -j ACCEPT  # æ’å…¥é¡¶éƒ¨
        echo "âœ… å·²å…è®¸IP $2 çš„å…¥ç«™è®¿é—®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰"
        ;;
    allow-out)
        if [ -z "$2" ]; then
            echo "âŒ é”™è¯¯ï¼šè¯·æä¾›IPåœ°å€"
            exit 1
        fi
        delete_duplicate_rules OUTPUT "-d $2 -j ACCEPT"
        iptables -I OUTPUT 1 -d "$2" -j ACCEPT  # æ’å…¥é¡¶éƒ¨
        echo "âœ… å·²å…è®¸IP $2 çš„å‡ºç«™è®¿é—®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰"
        ;;
    log-on)
        if ! iptables -L | grep -q "LOGGING"; then
            iptables -N LOGGING
            iptables -A INPUT -j LOGGING
            iptables -A LOGGING -m limit --limit 5/min -j LOG --log-prefix "$LOG_PREFIX: " --log-level 4
            iptables -A LOGGING -j DROP
            echo "âœ… æ—¥å¿—è®°å½•å·²å¼€å¯ï¼Œå‰ç¼€ä¸º $LOG_PREFIX"
        else
            echo "âš ï¸ æ—¥å¿—è®°å½•å·²å¯ç”¨"
        fi
        ;;
    log-off)
        if iptables -L | grep -q "LOGGING"; then
            iptables -F LOGGING
            iptables -X LOGGING
        fi
        echo "âœ… æ—¥å¿—è®°å½•å·²å…³é—­"
        ;;
    setup-secure)
        current_ip=$(get_ssh_ip)
        if [ -z "$current_ip" ]; then
            echo "âš ï¸ æ— æ³•è·å–å½“å‰SSH IPï¼Œè¯·æ‰‹åŠ¨æ”¾è¡Œ"
            set_default_policy
            allow_basic_services
        else
            echo "ğŸ”’ å®‰å…¨åˆå§‹åŒ–æ¨¡å¼å¯åŠ¨..."
            echo "âœ… å½“å‰SSH IPï¼š$current_ip"
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            mkdir -p "$BAK_DIR"
            
            # ä¿å­˜å½“å‰è§„åˆ™
            iptables-save > "$BAK_DIR/iptables.bak.$DATE"
            echo "ğŸ“ è§„åˆ™å·²å¤‡ä»½åˆ° $BAK_DIR/iptables.bak.$DATE"
            
            # è®¾ç½®é»˜è®¤ç­–ç•¥
            set_default_policy
            allow_basic_services
            
            # å…è®¸å½“å‰SSHè¿æ¥å’Œç«¯å£
            iptables -I INPUT 1 -s "$current_ip" -j ACCEPT
            iptables -I INPUT 2 -p tcp --dport 22 -j ACCEPT
            
            echo "âœ… å®‰å…¨æ¨¡å¼å·²å¯åŠ¨ï¼Œé»˜è®¤æ‹’ç»æ‰€æœ‰å…¥ç«™ï¼Œä»…å…è®¸SSHè®¿é—®"
            
            # å¯åŠ¨æ¢å¤ä»»åŠ¡ï¼ˆ5åˆ†é’Ÿåè‡ªåŠ¨å›æ»šï¼‰
            (sleep 300 && 
             echo "â³ 5åˆ†é’Ÿè¶…æ—¶ï¼Œæ­£åœ¨å›æ»šé˜²ç«å¢™ç­–ç•¥..."
             iptables-restore < "$BAK_DIR/iptables.bak.$DATE"
            ) &
            echo "ğŸ”„ æ¢å¤ä»»åŠ¡å·²å¯åŠ¨ï¼ˆPID: $!ï¼‰ï¼Œè¯·ç«‹å³æµ‹è¯•SSHè¿æ¥"
            echo "ç¡®è®¤å®‰å…¨åæ‰§è¡Œ 'iptables -F' æ¸…é™¤æ¢å¤ä»»åŠ¡"
        fi
        ;;
    list)
        echo "âœ… å½“å‰iptablesè§„åˆ™ï¼š"
        iptables -L -n -v
        ;;
    save)
        echo "ğŸ’¾ æ­£åœ¨ä¿å­˜é˜²ç«å¢™è§„åˆ™..."
        case "$(grep -E '^ID=' /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '"')" in
            ubuntu|debian)
                iptables-save > /etc/iptables/rules.v4
                echo "âœ… Ubuntu/Debian: è§„åˆ™å·²ä¿å­˜åˆ° /etc/iptables/rules.v4"
                ;;
            centos|rhel|almalinux|rocky)
                service iptables save
                echo "âœ… CentOS/RHEL: è§„åˆ™å·²é€šè¿‡ service iptables save ä¿å­˜"
                ;;
            *)
                echo "âš ï¸ æœªçŸ¥ç³»ç»Ÿç±»å‹ï¼Œæ‰‹åŠ¨ä¿å­˜ï¼šiptables-save > /etc/sysconfig/iptables"
                ;;
        esac
        ;;
    restore-backup)
        if [ -d "$BAK_DIR" ]; then
            latest=$(ls -t "$BAK_DIR"/iptables.bak.* 2>/dev/null | head -n1)
            if [ -f "$latest" ]; then
                echo "ğŸ”„ æ­£åœ¨æ¢å¤å¤‡ä»½ï¼š$latest"
                iptables-restore < "$latest"
                echo "âœ… è§„åˆ™å·²æ¢å¤"
            else
                echo "âŒ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
            fi
        else
            echo "âŒ å¤‡ä»½ç›®å½•ä¸å­˜åœ¨"
        fi
        ;;
    *)
        echo "âŒ æœªçŸ¥å‘½ä»¤æˆ–å‚æ•°é”™è¯¯ã€‚ä½¿ç”¨ -h æŸ¥çœ‹å¸®åŠ©ã€‚"
        exit 1
        ;;
esac
```



```bash
sudo iptables -A INPUT -p tcp -s 192.168.1.100 --dport 22 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 22 -j DROP
sudo service iptables save
```
